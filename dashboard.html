<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flight Search Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        surface: '#0f172a',
        card: '#1e293b',
        cardHover: '#334155',
        accent: '#38bdf8',
        accentDim: '#0ea5e9',
        gold: '#fbbf24',
        emerald: '#34d399',
        warn: '#f87171',
      }
    }
  }
}
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
  body { font-family: 'Inter', sans-serif; }
  .fade-in { animation: fadeIn 0.4s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes pulse-glow { 0%,100% { box-shadow: 0 0 15px rgba(56,189,248,0.15); } 50% { box-shadow: 0 0 30px rgba(56,189,248,0.3); } }
  .glow { animation: pulse-glow 3s ease-in-out infinite; }
  .card-enter { transition: all 0.3s cubic-bezier(0.4,0,0.2,1); }
  .card-enter:hover { transform: translateY(-4px); }
  .slide-down { transition: max-height 0.4s ease, opacity 0.3s ease; overflow: hidden; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: #0f172a; }
  ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
  .logo-img { width: 32px; height: 32px; border-radius: 6px; background: white; object-fit: contain; }
  .badge-green { background: rgba(52,211,153,0.15); color: #34d399; border: 1px solid rgba(52,211,153,0.3); }
  .badge-yellow { background: rgba(251,191,36,0.15); color: #fbbf24; border: 1px solid rgba(251,191,36,0.3); }
  .badge-red { background: rgba(248,113,113,0.15); color: #f87171; border: 1px solid rgba(248,113,113,0.3); }
  .badge-blue { background: rgba(56,189,248,0.15); color: #38bdf8; border: 1px solid rgba(56,189,248,0.3); }
  .badge-purple { background: rgba(168,85,247,0.15); color: #a855f7; border: 1px solid rgba(168,85,247,0.3); }
  .rec-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
  .rec-1 { border-left: 4px solid #34d399; }
  .rec-2 { border-left: 4px solid #38bdf8; }
  .rec-3 { border-left: 4px solid #fbbf24; }
  .warning-banner { background: linear-gradient(90deg, rgba(248,113,113,0.1) 0%, rgba(251,191,36,0.1) 100%); }
  .cpp-excellent { color: #34d399; }
  .cpp-good { color: #fbbf24; }
  .cpp-fair { color: #fb923c; }
  .cpp-low { color: #94a3b8; }
  .spinner { border: 3px solid #334155; border-top: 3px solid #38bdf8; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  input[type="text"], input[type="date"] { background: #0f172a; border: 1px solid #334155; color: white; }
  input:focus { border-color: #38bdf8; outline: none; box-shadow: 0 0 0 2px rgba(56,189,248,0.2); }
  .rt-step-banner { background: linear-gradient(90deg, rgba(56,189,248,0.1) 0%, rgba(168,85,247,0.1) 100%); }
  .selected-flight-summary { background: linear-gradient(135deg, rgba(52,211,153,0.1) 0%, rgba(56,189,248,0.1) 100%); border: 1px solid rgba(52,211,153,0.3); }
  .flight-card-selectable { cursor: pointer; }
  .flight-card-selectable:hover { border-color: #38bdf8 !important; }
  .date-badge { background: rgba(168,85,247,0.15); color: #c084fc; border: 1px solid rgba(168,85,247,0.3); font-size: 11px; }
  .flex-toggle-active { background: #38bdf8; color: #0f172a; }
  .flex-toggle-inactive { background: #1e293b; color: #94a3b8; border: 1px solid #334155; }
</style>
</head>
<body class="bg-surface text-gray-100 min-h-screen">

<!-- Warning Banner (dynamic) -->
<div id="warningBanner" class="warning-banner border-b border-red-900/50 px-4 py-3 hidden">
  <div class="max-w-7xl mx-auto flex items-start gap-3">
    <svg class="w-5 h-5 text-warn mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
    <div id="warningList" class="text-sm space-y-1"></div>
    <button onclick="this.closest('#warningBanner').classList.add('hidden')" class="ml-auto text-gray-500 hover:text-gray-300 flex-shrink-0">âœ•</button>
  </div>
</div>

<!-- Header -->
<header class="border-b border-gray-800 bg-surface/80 backdrop-blur-sm sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-4 py-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <div class="flex items-center gap-3">
          <span class="text-3xl">âœˆï¸</span>
          <div>
            <h1 id="routeTitle" class="text-2xl font-bold">
              <span class="text-gray-400">Search flights below</span>
            </h1>
            <p id="routeSubtitle" class="text-sm text-gray-400"></p>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span id="dataSourceBadge"></span>
        <button onclick="toggleBalances()" class="flex items-center gap-2 bg-card hover:bg-cardHover px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          <span>ğŸ’°</span> Points Balances
          <svg id="balanceChevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
      </div>
    </div>
  </div>
</header>

<!-- Points Balances Panel -->
<div id="balancesPanel" class="slide-down max-h-0 opacity-0 border-b border-gray-800 bg-card/50">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Points & Miles Balances</h3>
    <div id="balancesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
  </div>
</div>

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-4 py-6">

  <!-- Search Form -->
  <section id="searchForm" class="mb-8 fade-in">
    <div class="bg-card rounded-xl p-6 border border-gray-700/50">
      <h2 class="text-lg font-bold mb-4 flex items-center gap-2">ğŸ” Search Flights</h2>
      <form onsubmit="handleSearch(event)" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-4">
        <div>
          <label class="block text-xs text-gray-400 mb-1">From</label>
          <input type="text" id="inputFrom" value="LAX" placeholder="LAX" maxlength="3"
            class="w-full px-3 py-2.5 rounded-lg text-sm font-mono uppercase" />
        </div>
        <div>
          <label class="block text-xs text-gray-400 mb-1">To</label>
          <input type="text" id="inputTo" value="DXB" placeholder="DXB" maxlength="3"
            class="w-full px-3 py-2.5 rounded-lg text-sm font-mono uppercase" />
        </div>
        <div>
          <label class="block text-xs text-gray-400 mb-1">Depart</label>
          <input type="date" id="inputDate" value="2026-04-28"
            class="w-full px-3 py-2.5 rounded-lg text-sm" />
        </div>
        <div>
          <label class="block text-xs text-gray-400 mb-1">Return <span class="text-gray-600">(optional)</span></label>
          <input type="date" id="inputReturn" value=""
            class="w-full px-3 py-2.5 rounded-lg text-sm" />
        </div>
        <div>
          <label class="block text-xs text-gray-400 mb-1">Class</label>
          <select id="inputClass" class="w-full px-3 py-2.5 rounded-lg text-sm bg-surface border border-gray-700 text-white">
            <option value="both">All Classes</option>
            <option value="ECON">Economy</option>
            <option value="PREM">Business/First</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-gray-400 mb-1">Flexible Dates</label>
          <div class="flex gap-1 h-[42px]">
            <button type="button" onclick="setFlex(0)" id="flex-0" class="flex-1 rounded-lg text-xs font-bold flex-toggle-active">Exact</button>
            <button type="button" onclick="setFlex(1)" id="flex-1" class="flex-1 rounded-lg text-xs font-bold flex-toggle-inactive">Â±1d</button>
            <button type="button" onclick="setFlex(2)" id="flex-2" class="flex-1 rounded-lg text-xs font-bold flex-toggle-inactive">Â±2d</button>
          </div>
        </div>
        <div class="flex items-end">
          <button type="submit" id="searchBtn"
            class="w-full bg-accent hover:bg-accentDim text-surface font-bold py-2.5 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
            <span id="searchBtnText">Search</span>
            <div id="searchSpinner" class="spinner hidden"></div>
          </button>
        </div>
      </form>
      <p class="text-xs text-gray-500 mt-3">
        Sources: Roame (award flights across 19+ programs) Â· Google Flights (cash prices via SerpAPI) Â· Results saved to results.json
      </p>
    </div>
  </section>

  <!-- Loading indicator -->
  <div id="loadingSection" class="hidden text-center py-20">
    <div class="spinner mx-auto mb-4" style="width:48px;height:48px;border-width:4px"></div>
    <p class="text-gray-400" id="loadingText">Searching flights...</p>
  </div>

  <!-- Results Section (hidden until data loads) -->
  <div id="resultsSection" class="hidden">

    <!-- RT Step Banner -->
    <div id="rtBanner" class="hidden rt-step-banner rounded-xl p-4 mb-6 border border-accent/20 fade-in">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div id="rtStepIndicator" class="flex items-center gap-2">
            <span id="rtStep1Dot" class="w-8 h-8 rounded-full bg-accent text-surface flex items-center justify-center text-sm font-bold">1</span>
            <span class="text-gray-500 mx-1">â†’</span>
            <span id="rtStep2Dot" class="w-8 h-8 rounded-full bg-gray-700 text-gray-400 flex items-center justify-center text-sm font-bold">2</span>
          </div>
          <div>
            <p id="rtStepTitle" class="font-bold text-white"></p>
            <p id="rtStepSubtitle" class="text-xs text-gray-400"></p>
          </div>
        </div>
        <button id="rtBackBtn" onclick="rtGoBack()" class="hidden text-sm text-accent hover:text-white transition-colors">â† Change outbound</button>
      </div>
    </div>

    <!-- Selected Outbound Summary (shown during return selection) -->
    <div id="selectedOutboundSummary" class="hidden selected-flight-summary rounded-xl p-4 mb-4 fade-in">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-emerald font-semibold uppercase tracking-wider mb-1">âœ“ Selected Outbound</p>
          <p id="selectedOutboundText" class="text-sm text-white font-medium"></p>
        </div>
        <div id="selectedOutboundPrice" class="text-right"></div>
      </div>
    </div>

    <!-- TOP RECOMMENDATIONS -->
    <section id="recsSection" class="mb-10 fade-in hidden">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">ğŸ† <span>Top Recommendations</span></h2>
      <div id="recsContainer" class="grid md:grid-cols-3 gap-4"></div>
    </section>

    <!-- Controls -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6 bg-card rounded-xl p-4 border border-gray-700/50">
      <div class="flex gap-1 bg-surface rounded-lg p-1">
        <button onclick="setClass('all')" id="tab-all" class="px-5 py-2 rounded-md text-sm font-semibold transition-all bg-accent text-surface">All</button>
        <button onclick="setClass('economy')" id="tab-economy" class="px-5 py-2 rounded-md text-sm font-semibold transition-all text-gray-400 hover:text-white">Economy</button>
        <button onclick="setClass('business')" id="tab-business" class="px-5 py-2 rounded-md text-sm font-semibold transition-all text-gray-400 hover:text-white">Business</button>
        <button onclick="setClass('first')" id="tab-first" class="px-5 py-2 rounded-md text-sm font-semibold transition-all text-gray-400 hover:text-white">First</button>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <div class="flex gap-1 bg-surface rounded-lg p-1">
          <button onclick="setFilter('all')" id="filter-all" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all bg-gray-700 text-white">All</button>
          <button onclick="setFilter('cash')" id="filter-cash" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all text-gray-400 hover:text-white">Cash</button>
          <button onclick="setFilter('award')" id="filter-award" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all text-gray-400 hover:text-white">Award</button>
        </div>

        <select onchange="setSort(this.value)" class="bg-surface border border-gray-700 text-sm rounded-lg px-3 py-1.5 text-gray-300 focus:outline-none focus:border-accent">
          <option value="value">Sort: Best Value</option>
          <option value="price">Sort: Price â†‘</option>
          <option value="points">Sort: Points â†‘</option>
          <option value="cpp">Sort: cpp â†“</option>
          <option value="duration">Sort: Duration â†‘</option>
          <option value="date">Sort: Date</option>
        </select>

        <span id="resultCount" class="text-xs text-gray-500"></span>
      </div>
    </div>

    <!-- Flight Cards Container -->
    <div id="flightsContainer" class="grid md:grid-cols-2 gap-4 mb-10"></div>

    <!-- Combined RT Price Summary (shown after both selected) -->
    <div id="rtPriceSummary" class="hidden bg-card rounded-xl p-6 border border-emerald/30 mb-10 fade-in">
      <h3 class="text-lg font-bold text-emerald mb-3">ğŸ« Round Trip Summary</h3>
      <div id="rtSummaryContent"></div>
    </div>

    <!-- No Results -->
    <div id="noResults" class="hidden text-center py-16">
      <p class="text-2xl mb-2">ğŸ¤·</p>
      <p class="text-gray-400">No flights match your filters</p>
    </div>
  </div>

</main>

<!-- Footer -->
<footer class="border-t border-gray-800 py-6 text-center text-xs text-gray-500">
  <p>Powered by Roame, SerpAPI, and AwardWallet. Prices and availability subject to change.</p>
  <p class="mt-1" id="footerTimestamp"></p>
</footer>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let dashboardData = null;
let currentClass = 'all';
let currentFilter = 'all';
let currentSort = 'value';
let flexDays = 0;

// RT pairing state
let rtMode = false;          // true if searching round trip
let rtStep = null;           // 'outbound' | 'return' | null
let selectedOutbound = null; // the selected outbound flight object

// â”€â”€â”€ Airline Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const airlineLogos = {
  'United': 'https://logo.clearbit.com/united.com',
  'Air Canada': 'https://logo.clearbit.com/aircanada.com',
  'Turkish': 'https://logo.clearbit.com/turkishairlines.com',
  'Qatar': 'https://logo.clearbit.com/qatarairways.com',
  'QR': 'https://logo.clearbit.com/qatarairways.com',
  'Emirates': 'https://logo.clearbit.com/emirates.com',
  'EK': 'https://logo.clearbit.com/emirates.com',
  'Alaska': 'https://logo.clearbit.com/alaskaair.com',
  'AS': 'https://logo.clearbit.com/alaskaair.com',
  'British Airways': 'https://logo.clearbit.com/britishairways.com',
  'BA': 'https://logo.clearbit.com/britishairways.com',
  'Air France': 'https://logo.clearbit.com/airfrance.com',
  'AF': 'https://logo.clearbit.com/airfrance.com',
  'KLM': 'https://logo.clearbit.com/klm.com',
  'Qantas': 'https://logo.clearbit.com/qantas.com',
  'Singapore': 'https://logo.clearbit.com/singaporeair.com',
  'SQ': 'https://logo.clearbit.com/singaporeair.com',
  'Cathay Pacific': 'https://logo.clearbit.com/cathaypacific.com',
  'CX': 'https://logo.clearbit.com/cathaypacific.com',
  'Delta': 'https://logo.clearbit.com/delta.com',
  'DL': 'https://logo.clearbit.com/delta.com',
  'American': 'https://logo.clearbit.com/aa.com',
  'AA': 'https://logo.clearbit.com/aa.com',
  'UA': 'https://logo.clearbit.com/united.com',
  'AC': 'https://logo.clearbit.com/aircanada.com',
  'TK': 'https://logo.clearbit.com/turkishairlines.com',
  'Royal Jordanian': 'https://logo.clearbit.com/rj.com',
  'RJ': 'https://logo.clearbit.com/rj.com',
  'Etihad': 'https://logo.clearbit.com/etihad.com',
  'EY': 'https://logo.clearbit.com/etihad.com',
  'ANA': 'https://logo.clearbit.com/ana.co.jp',
  'NH': 'https://logo.clearbit.com/ana.co.jp',
  'JAL': 'https://logo.clearbit.com/jal.co.jp',
  'JL': 'https://logo.clearbit.com/jal.co.jp',
};

const programDisplayNames = {
  ALASKA: 'Alaska',
  UNITED: 'United',
  AMERICAN: 'AA AAdvantage',
  DELTA: 'Delta SkyMiles',
  AEROPLAN: 'Aeroplan',
  FLYING_BLUE: 'Flying Blue',
  BRITISH_AIRWAYS: 'BA Avios',
  QANTAS: 'Qantas FF',
  EMIRATES: 'Emirates Skywards',
  QATAR: 'Qatar Privilege Club',
  SINGAPORE: 'KrisFlyer',
  VIRGIN_ATLANTIC: 'Virgin Atlantic',
  AVIANCA: 'LifeMiles',
  CATHAY: 'Asia Miles',
  ETIHAD: 'Etihad Guest',
  ANA: 'ANA Mileage Club',
  JAL: 'JAL Mileage Bank',
};

function getAirlineLogo(airline) {
  if (airlineLogos[airline]) return airlineLogos[airline];
  const first = airline.split(/[\/\s]/)[0];
  if (airlineLogos[first]) return airlineLogos[first];
  const code = airline.match(/^([A-Z]{2})\b/)?.[1];
  if (code && airlineLogos[code]) return airlineLogos[code];
  return '';
}

function formatDuration(min) {
  if (!min) return '';
  return `${Math.floor(min/60)}h${min%60}m`;
}

function formatPoints(n) {
  if (!n) return '0';
  if (n >= 1000) return `${Math.round(n/1000)}K`;
  return n.toLocaleString();
}

function getCppClass(cpp) {
  if (cpp >= 8) return 'cpp-excellent';
  if (cpp >= 4) return 'cpp-good';
  if (cpp >= 2) return 'cpp-fair';
  return 'cpp-low';
}

function formatTravelDate(dateStr) {
  if (!dateStr) return '';
  try {
    const d = new Date(dateStr + 'T12:00:00');
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    return `${days[d.getDay()]} ${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
  } catch { return dateStr; }
}

function getTravelDate(flight) {
  // Try travelDate field first, then extract from departureTime, then from leg field
  if (flight.travelDate) return flight.travelDate;
  if (flight.departureTime) {
    const m = flight.departureTime.match(/^(\d{4}-\d{2}-\d{2})/);
    if (m) return m[1];
  }
  if (flight.leg) {
    const m = flight.leg.match(/\(([A-Z][a-z]+ \d+)\)/);
    if (m) return m[1];
  }
  return '';
}

// â”€â”€â”€ Balance Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const programIcons = {
  'chase-ur': 'ğŸ¦',
  'marriott': 'ğŸ¨',
  'hilton': 'ğŸ¨',
  'bilt': 'ğŸ ',
  'southwest': '',
};

function renderBalances(balances) {
  const grid = document.getElementById('balancesGrid');
  grid.innerHTML = balances.slice(0, 12).map(b => {
    const icon = programIcons[b.programKey];
    const logo = !icon ? getAirlineLogo(b.program) : '';
    const iconHtml = icon 
      ? `<span class="text-xs">${icon}</span>` 
      : (logo ? `<img src="${logo}" class="w-4 h-4 rounded" onerror="this.style.display='none'">` : '');
    const colorClass = b.balance > 500000 ? 'text-accent' : b.balance > 100000 ? 'text-emerald' : b.balance > 50000 ? 'text-gold' : '';
    return `
      <div class="bg-surface rounded-lg p-3 border border-gray-700/50">
        <div class="flex items-center gap-2 mb-1">${iconHtml}<span class="text-xs text-gray-400">${b.program}</span></div>
        <p class="text-lg font-bold ${colorClass}">${b.displayBalance || b.balance.toLocaleString()}</p>
      </div>
    `;
  }).join('');
}

// â”€â”€â”€ Warning Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderWarnings(warnings) {
  if (!warnings || warnings.length === 0) return;
  const banner = document.getElementById('warningBanner');
  const list = document.getElementById('warningList');
  list.innerHTML = warnings.map(w => `<p class="text-warn font-semibold">${w}</p>`).join('');
  banner.classList.remove('hidden');
}

// â”€â”€â”€ Recommendation Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderRecommendations(recs) {
  if (!recs || recs.length === 0) return;
  const section = document.getElementById('recsSection');
  const container = document.getElementById('recsContainer');
  const colorMap = { emerald: 'emerald', accent: 'accent', gold: 'gold' };
  container.innerHTML = recs.map((rec, i) => {
    const c = colorMap[rec.badgeColor] || 'accent';
    return `
      <div class="rec-card rec-${i+1} rounded-xl p-5 card-enter ${i===0?'glow':''} border border-${c}/20">
        <div class="flex items-center justify-between mb-3">
          <span class="bg-${c}/20 text-${c} text-xs font-bold px-2 py-1 rounded-full">${rec.badgeText}</span>
          ${rec.cppValue ? `<span class="text-${c} font-bold text-lg">${rec.cppValue}</span>` : ''}
        </div>
        <h3 class="font-bold text-lg mb-2">${rec.title}</h3>
        <div class="space-y-2 text-sm text-gray-300 mb-4">
          ${rec.details.map(d => `<p>${d}</p>`).join('')}
          <div class="bg-surface/50 rounded-lg p-3 mt-3">
            <p class="text-${c} font-semibold">Total: ${rec.totalCost}</p>
          </div>
          ${rec.subtitle ? `<p class="text-gray-400 text-xs mt-2">${rec.subtitle}</p>` : ''}
        </div>
        <a href="${rec.bookingUrl}" target="_blank" class="block w-full text-center bg-${c}/20 hover:bg-${c}/30 text-${c} font-semibold py-2.5 rounded-lg transition-colors">Book â†’</a>
      </div>
    `;
  }).join('');
  section.classList.remove('hidden');
}

// â”€â”€â”€ Flight Card Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderFlightCard(flight, idx) {
  const isAward = flight.type === 'award';
  const logo = getAirlineLogo(flight.airline);
  const stopsLabel = flight.stops === 0 
    ? '<span class="text-emerald font-medium">Nonstop</span>' 
    : `${flight.stops} stop${flight.stops > 1 ? 's' : ''}`;
  const routeStr = flight.airports ? flight.airports.join(' â†’ ') : `${flight.origin} â†’ ${flight.destination}`;
  const duration = formatDuration(flight.durationMinutes);
  const cabinBadge = flight.cabinClass === 'business' ? 'badge-purple' 
    : flight.cabinClass === 'first' ? 'badge-red' : 'badge-blue';
  const cabinLabel = flight.cabinClass.charAt(0).toUpperCase() + flight.cabinClass.slice(1);
  
  // Travel date badge
  const travelDate = getTravelDate(flight);
  const travelDateDisplay = formatTravelDate(travelDate);
  const dateBadgeHtml = travelDateDisplay 
    ? `<span class="date-badge px-2 py-0.5 rounded-full font-medium">ğŸ“… ${travelDateDisplay}</span>` 
    : '';
  
  // Source badge
  const sourceBadge = flight.source === 'roame' 
    ? '<span class="badge-green text-[10px] px-1.5 py-0.5 rounded-full">LIVE</span>'
    : flight.source === 'google'
    ? '<span class="badge-blue text-[10px] px-1.5 py-0.5 rounded-full">Google</span>'
    : flight.source === 'aa-direct'
    ? '<span class="badge-yellow text-[10px] px-1.5 py-0.5 rounded-full">AA Direct</span>'
    : '<span class="badge-yellow text-[10px] px-1.5 py-0.5 rounded-full">Est.</span>';
  
  // RT mode: make card selectable
  const isSelectable = rtMode && (rtStep === 'outbound' || rtStep === 'return');
  const selectableClass = isSelectable ? 'flight-card-selectable' : '';
  const selectHandler = isSelectable ? `onclick="selectFlight(${idx})"` : '';
  
  // RT mode: show combined price hint if selecting return
  let combinedPriceHtml = '';
  if (rtStep === 'return' && selectedOutbound) {
    if (isAward && selectedOutbound.type === 'award') {
      const totalPts = (selectedOutbound.points || 0) + (flight.points || 0);
      const totalTax = (selectedOutbound.taxes || 0) + (flight.taxes || 0);
      combinedPriceHtml = `<div class="mt-2 pt-2 border-t border-gray-700/50 text-xs text-gray-400">RT total: <span class="text-accent font-bold">${formatPoints(totalPts)} pts</span> + $${totalTax.toFixed(0)} taxes</div>`;
    } else if (!isAward && selectedOutbound.type === 'cash') {
      const totalCash = (selectedOutbound.cashPrice || 0) + (flight.cashPrice || 0);
      combinedPriceHtml = totalCash > 0
        ? `<div class="mt-2 pt-2 border-t border-gray-700/50 text-xs text-gray-400">RT total: <span class="text-accent font-bold">$${totalCash.toLocaleString()}</span></div>`
        : '';
    } else {
      // Mixed: show both
      const outLabel = selectedOutbound.type === 'award' ? `${formatPoints(selectedOutbound.points)} pts` : `$${selectedOutbound.cashPrice?.toLocaleString()}`;
      const retLabel = isAward ? `${formatPoints(flight.points)} pts` : `$${flight.cashPrice?.toLocaleString()}`;
      combinedPriceHtml = `<div class="mt-2 pt-2 border-t border-gray-700/50 text-xs text-gray-400">RT: ${outLabel} + ${retLabel}</div>`;
    }
  }
  
  if (isAward) {
    const programName = programDisplayNames[flight.pointsProgram] || flight.pointsProgram;
    const cppClass = flight.cppValue ? getCppClass(flight.cppValue) : 'cpp-low';
    const seats = flight.availableSeats ? `${flight.availableSeats} seat${flight.availableSeats > 1 ? 's' : ''}` : '';
    
    let statusBadge = '';
    if (dashboardData?.balances && flight.pointsProgram) {
      const bal = dashboardData.balances.find(b => b.programKey === flight.pointsProgram);
      if (bal) {
        if (bal.balance >= (flight.points || 0)) {
          statusBadge = `<span class="badge-green text-xs px-2 py-0.5 rounded-full">âœ… Have ${formatPoints(bal.balance)}</span>`;
        } else {
          const need = (flight.points || 0) - bal.balance;
          statusBadge = `<span class="badge-yellow text-xs px-2 py-0.5 rounded-full">Need ${formatPoints(need)} more</span>`;
        }
      }
    }
    
    return `
      <div class="bg-card rounded-xl p-5 border border-gray-700/50 card-enter hover:border-gray-600 fade-in ${selectableClass}" ${selectHandler}>
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center gap-3">
            ${logo ? `<img src="${logo}" class="logo-img" onerror="this.style.display='none'" alt="">` : ''}
            <div>
              <h3 class="font-bold text-white">${programName}</h3>
              <p class="text-xs text-gray-400">${flight.airline} Â· ${stopsLabel}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-2xl font-bold text-white">${formatPoints(flight.points)}</p>
            <div class="flex items-center gap-1 justify-end flex-wrap">
              <span class="${cabinBadge} text-xs px-2 py-0.5 rounded-full">${cabinLabel}</span>
              ${sourceBadge}
            </div>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-2 mb-3">
          ${dateBadgeHtml}
          ${statusBadge}
          ${flight.cppValue ? `<span class="${cppClass} text-sm font-bold">${flight.cppValue}Â¢/mi</span>` : ''}
          ${seats ? `<span class="text-xs text-gray-500">${seats}</span>` : ''}
          ${flight.roameScore ? `<span class="text-xs text-gray-500">Score: ${flight.roameScore}</span>` : ''}
        </div>
        <div class="text-xs text-gray-400 mb-2 space-y-0.5">
          <p>ğŸ“ ${routeStr}</p>
          <p>âœˆï¸ ${flight.flightNumbers?.join(' / ') || ''} Â· â± ${duration}</p>
          ${flight.equipment?.filter(Boolean).length ? `<p>ğŸ›©ï¸ ${flight.equipment.join(', ')}</p>` : ''}
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-400">+ $${(flight.taxes || 0).toFixed(0)} taxes</span>
          ${isSelectable 
            ? `<span class="text-accent font-medium">Select ${rtStep === 'outbound' ? 'outbound' : 'return'} â†’</span>`
            : `<a href="${flight.bookingUrl}" target="_blank" class="text-accent hover:text-white font-medium transition-colors">Book â†’</a>`
          }
        </div>
        ${combinedPriceHtml}
      </div>
    `;
  } else {
    // Cash flight
    return `
      <div class="bg-card rounded-xl p-5 border border-gray-700/50 card-enter hover:border-gray-600 fade-in ${selectableClass}" ${selectHandler}>
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center gap-3">
            ${logo ? `<img src="${logo}" class="logo-img" onerror="this.style.display='none'" alt="">` : ''}
            <div>
              <h3 class="font-bold text-white">${flight.airline}</h3>
              <p class="text-xs text-gray-400">${stopsLabel}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-2xl font-bold text-white">${flight.cashPrice ? '$' + flight.cashPrice.toLocaleString() : '<span class="text-gray-500 text-base">Price N/A</span>'}</p>
            <div class="flex items-center gap-1 justify-end flex-wrap">
              <span class="badge-blue text-xs px-2 py-0.5 rounded-full">Cash</span>
              ${sourceBadge}
            </div>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-2 mb-2">
          ${dateBadgeHtml}
          <span class="${cabinBadge} text-xs px-2 py-0.5 rounded-full">${cabinLabel}</span>
        </div>
        <div class="text-xs text-gray-400 mb-2 space-y-0.5">
          <p>ğŸ“ ${routeStr}</p>
          <p>âœˆï¸ ${flight.flightNumbers?.join(' / ') || ''} Â· â± ${duration}</p>
        </div>
        <div class="flex items-center justify-between text-sm">
          <span></span>
          ${isSelectable 
            ? `<span class="text-accent font-medium">Select ${rtStep === 'outbound' ? 'outbound' : 'return'} â†’</span>`
            : `<a href="${flight.bookingUrl}" target="_blank" class="text-accent hover:text-white font-medium transition-colors">Book â†’</a>`
          }
        </div>
        ${combinedPriceHtml}
      </div>
    `;
  }
}

// â”€â”€â”€ RT Pairing Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initRtFlow() {
  const hasReturn = dashboardData?.meta?.returnDate;
  const hasReturnFlights = dashboardData?.flights?.some(f => f.direction === 'return');
  
  rtMode = !!(hasReturn && hasReturnFlights);
  
  if (rtMode) {
    rtStep = 'outbound';
    selectedOutbound = null;
    updateRtBanner();
  } else {
    rtStep = null;
    selectedOutbound = null;
    document.getElementById('rtBanner').classList.add('hidden');
    document.getElementById('selectedOutboundSummary').classList.add('hidden');
    document.getElementById('rtPriceSummary').classList.add('hidden');
  }
}

function updateRtBanner() {
  const banner = document.getElementById('rtBanner');
  const step1Dot = document.getElementById('rtStep1Dot');
  const step2Dot = document.getElementById('rtStep2Dot');
  const title = document.getElementById('rtStepTitle');
  const subtitle = document.getElementById('rtStepSubtitle');
  const backBtn = document.getElementById('rtBackBtn');
  
  if (!rtMode) {
    banner.classList.add('hidden');
    return;
  }
  
  banner.classList.remove('hidden');
  
  const m = dashboardData.meta;
  
  if (rtStep === 'outbound') {
    step1Dot.className = 'w-8 h-8 rounded-full bg-accent text-surface flex items-center justify-center text-sm font-bold';
    step2Dot.className = 'w-8 h-8 rounded-full bg-gray-700 text-gray-400 flex items-center justify-center text-sm font-bold';
    title.textContent = `Step 1: Select your outbound flight`;
    subtitle.textContent = `${m.origin} â†’ ${m.destination} Â· ${formatTravelDate(m.departureDate)}`;
    backBtn.classList.add('hidden');
    document.getElementById('selectedOutboundSummary').classList.add('hidden');
    document.getElementById('rtPriceSummary').classList.add('hidden');
  } else if (rtStep === 'return') {
    step1Dot.className = 'w-8 h-8 rounded-full bg-emerald text-surface flex items-center justify-center text-sm font-bold';
    step1Dot.textContent = 'âœ“';
    step2Dot.className = 'w-8 h-8 rounded-full bg-accent text-surface flex items-center justify-center text-sm font-bold';
    title.textContent = `Step 2: Select your return flight`;
    subtitle.textContent = `${m.destination} â†’ ${m.origin} Â· ${formatTravelDate(m.returnDate)}`;
    backBtn.classList.remove('hidden');
    
    // Show selected outbound summary
    showSelectedOutbound();
  }
}

function showSelectedOutbound() {
  if (!selectedOutbound) return;
  const el = document.getElementById('selectedOutboundSummary');
  const textEl = document.getElementById('selectedOutboundText');
  const priceEl = document.getElementById('selectedOutboundPrice');
  
  const f = selectedOutbound;
  const dateDisplay = formatTravelDate(getTravelDate(f));
  textEl.textContent = `${f.airline} Â· ${f.origin}â†’${f.destination} Â· ${dateDisplay} Â· ${f.cabinClass}`;
  
  if (f.type === 'award') {
    priceEl.innerHTML = `<span class="text-white font-bold">${formatPoints(f.points)} pts</span><br><span class="text-xs text-gray-400">+ $${(f.taxes||0).toFixed(0)}</span>`;
  } else {
    priceEl.innerHTML = `<span class="text-white font-bold">${f.cashPrice ? '$' + f.cashPrice.toLocaleString() : '<span class="text-gray-500">Price N/A</span>'}</span>`;
  }
  
  el.classList.remove('hidden');
}

function selectFlight(idx) {
  const flights = getFilteredFlights();
  const flight = flights[idx];
  if (!flight) return;
  
  if (rtStep === 'outbound') {
    selectedOutbound = flight;
    rtStep = 'return';
    updateRtBanner();
    render();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } else if (rtStep === 'return') {
    // Show combined RT summary
    showRtSummary(selectedOutbound, flight);
  }
}

function rtGoBack() {
  if (rtStep === 'return') {
    rtStep = 'outbound';
    selectedOutbound = null;
    updateRtBanner();
    render();
  }
}

function showRtSummary(outbound, returnFlight) {
  const summaryEl = document.getElementById('rtPriceSummary');
  const contentEl = document.getElementById('rtSummaryContent');
  
  const outDate = formatTravelDate(getTravelDate(outbound));
  const retDate = formatTravelDate(getTravelDate(returnFlight));
  
  let totalHtml = '';
  
  // Calculate combined costs
  if (outbound.type === 'award' && returnFlight.type === 'award') {
    const totalPts = (outbound.points || 0) + (returnFlight.points || 0);
    const totalTax = (outbound.taxes || 0) + (returnFlight.taxes || 0);
    const sameProgram = outbound.pointsProgram === returnFlight.pointsProgram;
    totalHtml = `
      <div class="text-2xl font-bold text-emerald">${formatPoints(totalPts)} pts + $${totalTax.toFixed(0)}</div>
      ${sameProgram ? `<p class="text-sm text-gray-400 mt-1">Both via ${programDisplayNames[outbound.pointsProgram] || outbound.pointsProgram}</p>` : 
        `<p class="text-sm text-gray-400 mt-1">Out: ${programDisplayNames[outbound.pointsProgram] || outbound.pointsProgram} Â· Ret: ${programDisplayNames[returnFlight.pointsProgram] || returnFlight.pointsProgram}</p>`}
    `;
  } else if (outbound.type === 'cash' && returnFlight.type === 'cash') {
    const outCash = outbound.cashPrice || 0;
    const retCash = returnFlight.cashPrice || 0;
    const total = outCash + retCash;
    totalHtml = total > 0 
      ? `<div class="text-2xl font-bold text-emerald">$${total.toLocaleString()} total</div>`
      : `<div class="text-xl font-bold text-gray-500">Price unavailable</div>`;
  } else {
    const outLabel = outbound.type === 'award' ? `${formatPoints(outbound.points)} pts + $${(outbound.taxes||0).toFixed(0)}` : (outbound.cashPrice ? `$${outbound.cashPrice.toLocaleString()}` : 'Price N/A');
    const retLabel = returnFlight.type === 'award' ? `${formatPoints(returnFlight.points)} pts + $${(returnFlight.taxes||0).toFixed(0)}` : (returnFlight.cashPrice ? `$${returnFlight.cashPrice.toLocaleString()}` : 'Price N/A');
    totalHtml = `<div class="text-xl font-bold text-emerald">Out: ${outLabel} + Ret: ${retLabel}</div>`;
  }
  
  contentEl.innerHTML = `
    <div class="grid md:grid-cols-2 gap-4 mb-4">
      <div class="bg-surface/50 rounded-lg p-3">
        <p class="text-xs text-emerald font-semibold mb-1">OUTBOUND Â· ${outDate}</p>
        <p class="text-white font-medium">${outbound.airline} Â· ${outbound.origin}â†’${outbound.destination}</p>
        <p class="text-xs text-gray-400">${outbound.cabinClass} Â· ${outbound.type === 'award' ? formatPoints(outbound.points) + ' pts' : (outbound.cashPrice ? '$' + outbound.cashPrice.toLocaleString() : 'Price N/A')}</p>
      </div>
      <div class="bg-surface/50 rounded-lg p-3">
        <p class="text-xs text-accent font-semibold mb-1">RETURN Â· ${retDate}</p>
        <p class="text-white font-medium">${returnFlight.airline} Â· ${returnFlight.origin}â†’${returnFlight.destination}</p>
        <p class="text-xs text-gray-400">${returnFlight.cabinClass} Â· ${returnFlight.type === 'award' ? formatPoints(returnFlight.points) + ' pts' : (returnFlight.cashPrice ? '$' + returnFlight.cashPrice.toLocaleString() : 'Price N/A')}</p>
      </div>
    </div>
    <div class="flex items-center justify-between">
      ${totalHtml}
      <div class="flex gap-2">
        <a href="${outbound.bookingUrl}" target="_blank" class="bg-emerald/20 hover:bg-emerald/30 text-emerald font-semibold px-4 py-2 rounded-lg text-sm transition-colors">Book Outbound â†’</a>
        <a href="${returnFlight.bookingUrl}" target="_blank" class="bg-accent/20 hover:bg-accent/30 text-accent font-semibold px-4 py-2 rounded-lg text-sm transition-colors">Book Return â†’</a>
      </div>
    </div>
    <button onclick="rtGoBack()" class="mt-3 text-sm text-gray-400 hover:text-white transition-colors">â† Start over</button>
  `;
  
  summaryEl.classList.remove('hidden');
  summaryEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// â”€â”€â”€ Filtering & Sorting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function getFilteredFlights() {
  if (!dashboardData?.flights) return [];
  
  let flights = [...dashboardData.flights];
  
  // RT direction filter
  if (rtMode) {
    if (rtStep === 'outbound') {
      flights = flights.filter(f => f.direction === 'outbound' || !f.direction);
    } else if (rtStep === 'return') {
      flights = flights.filter(f => f.direction === 'return');
    }
  }
  
  // Class filter
  if (currentClass !== 'all') {
    flights = flights.filter(f => f.cabinClass === currentClass);
  }
  
  // Type filter
  if (currentFilter === 'cash') {
    flights = flights.filter(f => f.type === 'cash');
  } else if (currentFilter === 'award') {
    flights = flights.filter(f => f.type === 'award');
  }
  
  // Sort
  flights.sort((a, b) => {
    switch (currentSort) {
      case 'value':
        if (a.type === 'award' && b.type === 'award') return (b.cppValue || 0) - (a.cppValue || 0);
        if (a.type === 'cash' && b.type === 'cash') return (a.cashPrice || Infinity) - (b.cashPrice || Infinity);
        if (a.type === 'award') return -1;
        return 1;
      case 'price':
        const pa = a.type === 'cash' ? (a.cashPrice || Infinity) : (a.taxes || 0);
        const pb = b.type === 'cash' ? (b.cashPrice || Infinity) : (b.taxes || 0);
        return pa - pb;
      case 'points':
        return (a.points || Infinity) - (b.points || Infinity);
      case 'cpp':
        return (b.cppValue || 0) - (a.cppValue || 0);
      case 'duration':
        return (a.durationMinutes || Infinity) - (b.durationMinutes || Infinity);
      case 'date':
        const da = getTravelDate(a) || '9999';
        const db = getTravelDate(b) || '9999';
        return da.localeCompare(db);
      default: return 0;
    }
  });
  
  return flights;
}

function render() {
  const flights = getFilteredFlights();
  const container = document.getElementById('flightsContainer');
  const noResults = document.getElementById('noResults');
  const countEl = document.getElementById('resultCount');
  
  if (flights.length === 0) {
    container.innerHTML = '';
    noResults.classList.remove('hidden');
    countEl.textContent = '0 results';
    return;
  }
  
  noResults.classList.add('hidden');
  
  const dirLabel = rtMode ? (rtStep === 'outbound' ? ' outbound' : ' return') : '';
  countEl.textContent = `${flights.length}${dirLabel} result${flights.length !== 1 ? 's' : ''}`;
  container.innerHTML = flights.map((f, i) => renderFlightCard(f, i)).join('');
}

// â”€â”€â”€ Control Handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function setClass(cls) {
  currentClass = cls;
  ['all','economy','business','first'].forEach(v => {
    const el = document.getElementById('tab-'+v);
    if (el) el.className = v === cls
      ? 'px-5 py-2 rounded-md text-sm font-semibold transition-all bg-accent text-surface'
      : 'px-5 py-2 rounded-md text-sm font-semibold transition-all text-gray-400 hover:text-white';
  });
  render();
}

function setFilter(f) {
  currentFilter = f;
  ['all','cash','award'].forEach(v => {
    document.getElementById('filter-'+v).className = v === f
      ? 'px-3 py-1.5 rounded-md text-xs font-medium transition-all bg-gray-700 text-white'
      : 'px-3 py-1.5 rounded-md text-xs font-medium transition-all text-gray-400 hover:text-white';
  });
  render();
}

function setSort(s) {
  currentSort = s;
  render();
}

function setFlex(n) {
  flexDays = n;
  [0, 1, 2].forEach(v => {
    const el = document.getElementById('flex-' + v);
    el.className = v === n
      ? 'flex-1 rounded-lg text-xs font-bold flex-toggle-active'
      : 'flex-1 rounded-lg text-xs font-bold flex-toggle-inactive';
  });
}

function toggleBalances() {
  const panel = document.getElementById('balancesPanel');
  const chevron = document.getElementById('balanceChevron');
  if (panel.style.maxHeight && panel.style.maxHeight !== '0px') {
    panel.style.maxHeight = '0px'; panel.style.opacity = '0';
    chevron.style.transform = 'rotate(0deg)';
  } else {
    panel.style.maxHeight = '500px'; panel.style.opacity = '1';
    chevron.style.transform = 'rotate(180deg)';
  }
}

// â”€â”€â”€ Search Handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function handleSearch(event) {
  event.preventDefault();
  
  const from = document.getElementById('inputFrom').value.toUpperCase().trim();
  const to = document.getElementById('inputTo').value.toUpperCase().trim();
  const date = document.getElementById('inputDate').value;
  const ret = document.getElementById('inputReturn').value;
  const cls = document.getElementById('inputClass').value;
  
  if (!from || !to || !date) {
    alert('Please fill in From, To, and Departure Date');
    return;
  }
  
  // Show loading
  document.getElementById('searchBtn').disabled = true;
  document.getElementById('searchBtnText').textContent = 'Searching...';
  document.getElementById('searchSpinner').classList.remove('hidden');
  document.getElementById('loadingSection').classList.remove('hidden');
  document.getElementById('resultsSection').classList.add('hidden');
  
  const flexLabel = flexDays > 0 ? ` (Â±${flexDays} day${flexDays > 1 ? 's' : ''})` : '';
  document.getElementById('loadingText').textContent = `Searching ${from} â†’ ${to}${flexLabel} across all programs...`;
  
  try {
    const searchUrl = `./api/search?from=${from}&to=${to}&date=${date}&return=${ret}&class=${cls}&flex=${flexDays}`;
    
    try {
      const resp = await fetch(searchUrl);
      if (resp.ok) {
        dashboardData = await resp.json();
        displayResults();
        return;
      }
    } catch (e) {
      console.log('Search API not available, loading results.json');
    }
    
    // Fallback: load existing results.json
    const resp = await fetch('./results.json?t=' + Date.now());
    if (resp.ok) {
      dashboardData = await resp.json();
      displayResults();
    } else {
      document.getElementById('loadingText').textContent = 
        'No results.json found. Run: npx tsx search.ts --from ' + from + ' --to ' + to + ' --date ' + date;
    }
  } catch (err) {
    document.getElementById('loadingText').textContent = `Error: ${err.message}`;
  } finally {
    document.getElementById('searchBtn').disabled = false;
    document.getElementById('searchBtnText').textContent = 'Search';
    document.getElementById('searchSpinner').classList.add('hidden');
  }
}

// â”€â”€â”€ Display Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function displayResults() {
  if (!dashboardData) return;
  
  const m = dashboardData.meta;
  
  // Update header
  document.getElementById('routeTitle').innerHTML = `
    <span class="text-white">${m.origin}</span>
    <span class="text-accent mx-2">â†’</span>
    <span class="text-white">${m.destination}</span>
  `;
  
  const dateStr = new Date(m.departureDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  const retStr = m.returnDate ? ` â†’ ${new Date(m.returnDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}` : ' (one-way)';
  document.getElementById('routeSubtitle').textContent = `${dateStr}${retStr}`;
  document.title = `${m.origin} â†’ ${m.destination} Flight Search`;
  
  // Data source badge
  const sources = m.sources || [];
  const liveCount = dashboardData.flights?.filter(f => f.source === 'roame').length || 0;
  document.getElementById('dataSourceBadge').innerHTML = liveCount > 0
    ? `<span class="badge-green text-xs px-2 py-1 rounded-full font-medium">ğŸ”´ ${liveCount} LIVE fares</span>`
    : `<span class="badge-yellow text-xs px-2 py-1 rounded-full font-medium">âš ï¸ Estimated data</span>`;
  
  // Render components
  if (dashboardData.balances) renderBalances(dashboardData.balances);
  if (dashboardData.warnings) renderWarnings(dashboardData.warnings);
  
  // Initialize RT flow (before rendering recommendations/flights)
  initRtFlow();
  
  // Only show recommendations in non-RT mode or flat view
  if (!rtMode && dashboardData.recommendations) {
    renderRecommendations(dashboardData.recommendations);
  } else {
    document.getElementById('recsSection').classList.add('hidden');
  }
  
  // Footer
  document.getElementById('footerTimestamp').textContent = 
    `Last searched: ${new Date(m.searchedAt).toLocaleString()}`;
  
  // Show results
  document.getElementById('loadingSection').classList.add('hidden');
  document.getElementById('resultsSection').classList.remove('hidden');
  
  render();
}

// â”€â”€â”€ Initialize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function init() {
  try {
    const resp = await fetch('./results.json');
    if (resp.ok) {
      dashboardData = await resp.json();
      
      if (dashboardData.meta) {
        document.getElementById('inputFrom').value = dashboardData.meta.origin || 'LAX';
        document.getElementById('inputTo').value = dashboardData.meta.destination || 'DXB';
        if (dashboardData.meta.departureDate) document.getElementById('inputDate').value = dashboardData.meta.departureDate;
        if (dashboardData.meta.returnDate) document.getElementById('inputReturn').value = dashboardData.meta.returnDate;
      }
      
      displayResults();
    }
  } catch (e) {
    console.log('No results.json found, waiting for search');
  }
}

init();
</script>
</body>
</html>
